<% @registryPermissions.each do |name, value| -%>

try {

    if (('<%= value['account'] %>'.Contains('@')) -or ('<%= value['account'] %>'.Contains('\'))) {
        $upn = '<%= value['account'] %>'
    } else {
        $upn = '<%= hostname %>\<%= value['account'] %>'
    }

    $acl= Get-Acl -Path '<%= value['aclpath'] %>'
    $inheritance = [System.Security.AccessControl.InheritanceFlags]'<%= value['inheritance'] %>'
    $propagation = [System.Security.AccessControl.PropagationFlags]'<%= value['propagation'] %>'
    $rule = New-Object System.Security.AccessControl.RegistryAccessRule ("$upn","<%= value['accessRights'] %>","$inheritance","$propagation","<%= value['accessType'] %>")
    $acl.AddAccessRule($rule)
    $acl | Set-Acl
} catch {
    Write-Error "Failed to set permissions for <%= value['aclpath'] %> registry key. Error: $_"
}

<%- end -%>