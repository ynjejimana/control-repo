#!/bin/bash

TS="$(date +%s)"
LATEST_SCAN_LOG="<%= @scanClamScanLogFile %>.latest"
TMP_SCAN_LOG="/tmp/clamscan.log.tmp.${TS}"

/usr/local/bin/freshclam.sh

echo "CLAMSCAN START: $(date +%Y%m%d%H%M%S) (${TS})" > ${TMP_SCAN_LOG}

/usr/bin/clamscan -roi \
<% if @scanMoveDir -%>
--move=<%= @scanMoveDir %> \
--exclude-dir='<%= @scanMoveDir -%>' \
<% end -%>
--exclude-dir='^/sys' \
--exclude-dir='^/proc' \
--exclude-dir='^/dev' \
<% @scanExcludePathList.each do |item| -%>
--exclude-dir='<%= item %>' \
<% end -%>
<% @scanExcludeFileList.each do |item| -%>
--exclude='<%= item %>' \
<% end -%>
-l <%= @scanClamScanLogFile %> \
--stdout / >> ${TMP_SCAN_LOG} 

if [ $? -eq 0 ]
then
  echo -e "\nCLAMSCAN STOP: $(date +%Y%m%d%H%M%S) ($(date +%s))" >> $TMP_SCAN_LOG
  mv -f $TMP_SCAN_LOG $LATEST_SCAN_LOG
  /usr/bin/logger -f $LATEST_SCAN_LOG -t clamav -p local6.info
  exit 0
else
  rm -f $TMP_SCAN_LOG
  exit 255
fi
