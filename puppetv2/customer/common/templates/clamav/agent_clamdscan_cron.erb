#!/bin/bash

TS="$(date +%s)"
LATEST_SCAN_LOG="<%= @scanClamScanLogFile %>.latest"
TMP_SCAN_LOG="/tmp/clamscan.log.tmp.${TS}"

echo "CLAMSCAN START: $(date +%Y%m%d%H%M%S) (${TS})" > ${TMP_SCAN_LOG}

/usr/bin/clamdscan -m --fdpass \
<% if @scanMoveDir -%>
--move=<%= @scanMoveDir %> \
<% end -%>
-l <%= @scanClamScanLogFile %> \
/ \
--stdout >> ${TMP_SCAN_LOG}

case $? in
0|2)
  echo -e "\nCLAMSCAN STOP: $(date +%Y%m%d%H%M%S) ($(date +%s))" >> $TMP_SCAN_LOG
  mv -f $TMP_SCAN_LOG $LATEST_SCAN_LOG
  /usr/bin/logger -f $LATEST_SCAN_LOG -t clamav -p local6.info
  exit 0
  ;;
*)
  rm $TMP_SCAN_LOG
  exit 255
  ;;
esac

